# M4 ‚Äì Log Manager & QA Traceability

## üìò Objective:
Implement **M4 ‚Äì Log Manager & QA Traceability**:

* Centralize JSONL ingestion (M2/M3 logs)
* Produce **monthly JSONL** + **Tableau-ready CSV**
* **Appender mode**: `--append true` ‚Üí add/update the month row without duplicates
* **Confidence sparkline** (unicode) with **`--sparklen`** to limit length (downsample)

## üìÇ File paths:
* `src/logging/log_manager.py`
* `tests/test_log_manager.py`
* `docs/prompts/module-04.txt` (save this prompt + notes)
* `requirements.txt` (ensure `pandas`, `jsonlines`)
* `src/context/ProjectVision.ts` (M4: active + changelog)

## üîó Dependencies:
`pandas`, `jsonlines` (no extra libs)

## üß† Key functions:
* `load_jsonl(path)`
* `summarize_inference_logs(pattern)`
* `summarize_writer_logs(pattern)`
* `aggregate_metrics(df_inf, df_wrt, sparklen:int)`
* `log_integrity_check(inf_int, wrt_int)`
* `compose_monthly_summary(month, sparklen:int)`
* `save_summary_jsonl(data, path)`
* `save_summary_csv(data, path, append=False)`
* `make_sparkline(values, max_len:int|None)`
* `_downsample(values, max_len:int)`

## ‚ö†Ô∏è Compliance Note:
```
# Read-only regarding original logs & Excel files.
# Do NOT modify or delete any existing inputs.
# Include timestamps and file checksums for audit traceability.
```

## üñ•Ô∏è CLI Examples

```bash
# Monthly summary (overwrite CSV; default sparklen=40)
python -m src.logging.log_manager --month 202510

# Append/update CSV row for 202510 (no duplicates), print JSON
python -m src.logging.log_manager --month 202510 --append true --verbose true

# Tighter sparkline (e.g., 20 glyphs)
python -m src.logging.log_manager --month 202510 --sparklen 20

# Custom output paths
python -m src.logging.log_manager --month 202510 \
  --output_csv logs/monthly_metrics_summary.csv \
  --output_jsonl logs/metrics_summary_202510.jsonl \
  --append true --sparklen 30
```

## ‚úÖ Acceptance Checklist
* [x] Aggregates M2 (inference) + M3 (writer) logs by month
* [x] Saves JSONL + CSV under `/logs/`
* [x] **Appender mode** de-dupes by `month`
* [x] **Sparkline** present with **`--sparklen`** respected
* [x] Integrity: SHA256 + missing-field counters included
* [x] Tests pass with mock logs

---

DEV NOTES:
- M2 pattern: logs/mtcr_review_assistant_YYYYMM.jsonl (monthly).
- M3 pattern: logs/mtcr_writer.jsonl (rolling; adjust if rotated).
- --append true ‚Üí add/update month row without duplicates in CSV.
- Confidence sparkline: unicode mini-chart with --sparklen (default 40) to downsample long months.
- Integrity: per-file SHA256 + missing-field counters.
- Next (M5): consume monthly CSV for taxonomy drift detection and label merges.